import React, { useState, useEffect, useMemo, useCallback } from 'react';
import {
  Box, Typography, Table, TableBody, TableCell, TableContainer, TableHead, TableRow, Paper,
  IconButton, Button, TextField, InputAdornment, useTheme, CircularProgress, Dialog, DialogTitle,
  DialogContent, DialogActions, Stack, Snackbar,
  TableSortLabel, TablePagination, DialogContentText
} from '@mui/material';
import EditIcon from '@mui/icons-material/Edit';
import DeleteIcon from '@mui/icons-material/Delete';
import AddIcon from '@mui/icons-material/Add';
import SearchIcon from '@mui/icons-material/Search';
import CloseIcon from '@mui/icons-material/Close';
import MuiAlert, { type AlertProps } from '@mui/material/Alert';

// Custom Alert component for Snackbar
const Alert = React.forwardRef<HTMLDivElement, AlertProps>(function Alert(props, ref) {
  return <MuiAlert elevation={6} ref={ref} variant="filled" {...props} />;
});

// --- INTERFACES ---
interface Brand {
  brand_id: number;
  brand_name: string;
  logo: string; // T√™n file logo
  description: string;
  slug: string; // ‚úÖ ƒê√É TH√äM TR∆Ø·ªúNG SLUG
}

// ‚úÖ M·ªöI: Interface ri√™ng cho d·ªØ li·ªáu form trong modal c·ªßa Brand
interface ModalBrandFormData {
  brand_name?: string;
  description?: string;
  slug?: string; // ‚úÖ ƒê√É TH√äM SLUG V√ÄO FORM DATA
}

type Order = 'asc' | 'desc';
type HeadCellId = keyof Brand | 'actions'; 

interface HeadCell {
  id: HeadCellId;
  label: string;
  numeric: boolean;
  disableSorting?: boolean;
}

const headCells: HeadCell[] = [
  { id: 'brand_id', numeric: false, label: 'ID' },
  { id: 'brand_name', numeric: false, label: 'T√™n Th∆∞∆°ng hi·ªáu' },
  { id: 'slug', numeric: false, label: 'Slug' }, // ‚úÖ ƒê√É TH√äM C·ªòT SLUG V√ÄO HEADCELLS
  { id: 'logo', numeric: false, label: 'Logo', disableSorting: true },
  { id: 'description', numeric: false, label: 'M√¥ t·∫£', disableSorting: true },
];

// --- UTILITY FUNCTIONS FOR SORTING ---
function descendingComparator<T>(a: T, b: T, orderBy: keyof T) {
  if (b[orderBy] < a[orderBy]) {
    return -1;
  }
  if (b[orderBy] > a[orderBy]) {
    return 1;
  }
  return 0;
}

function getComparator<Key extends keyof Brand>(
  order: Order,
  orderBy: Key,
): (a: { [key in Key]: number | string }, b: { [key in Key]: number | string }) => number {
  return order === 'desc'
    ? (a, b) => descendingComparator(a, b, orderBy)
    : (a, b) => -descendingComparator(a, b, orderBy);
}

function stableSort<T>(array: readonly T[], comparator: (a: T, b: T) => number) {
  const stabilizedThis = array.map((el, index) => [el, index] as [T, number]);
  stabilizedThis.sort((a, b) => {
    const order = comparator(a[0], b[0]);
    if (order !== 0) {
      return order;
    }
    return a[1] - b[1];
  });
  return stabilizedThis.map((el) => el[0]);
}

// --- BRAND MANAGER COMPONENT ---
export default function BrandManagerr() { // Gi·ªØ nguy√™n t√™n component c·ªßa b·∫°n
  const theme = useTheme();

  const [brands, setBrands] = useState<Brand[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  const [page, setPage] = useState<number>(0);
  const [rowsPerPage, setRowsPerPage] = useState<number>(10); 

  const [order, setOrder] = useState<Order>('asc');
  const [orderBy, setOrderBy] = useState<HeadCellId>('brand_id');

  const [searchTerm, setSearchTerm] = useState<string>('');

  const [isModalOpen, setIsModalOpen] = useState<boolean>(false);
  const [editingBrand, setEditingBrand] = useState<Brand | null>(null);
  const [modalFormData, setModalFormData] = useState<ModalBrandFormData>({}); 
  const [logoFile, setLogoFile] = useState<File | null>(null);
  const [logoPreview, setLogoPreview] = useState<string>('');

  const [openConfirmDialog, setOpenConfirmDialog] = useState(false);
  const [deletingId, setDeletingId] = useState<number | null>(null);

  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState('');
  const [snackbarSeverity, setSnackbarSeverity] = useState<'success' | 'error'>('success');

  const API_BASE_URL = 'http://localhost:3000/api/brands';
  const UPLOADS_BASE_URL = 'http://localhost:3000/uploads/';

  // ‚úÖ ƒê·∫¢M B·∫¢O showSnackbar ƒê∆Ø·ª¢C ƒê·ªäNH NGHƒ®A TR∆Ø·ªöC C√ÅC H√ÄM G·ªåI N√ì
  const showSnackbar = useCallback((message: string, severity: 'success' | 'error') => {
    setSnackbarMessage(message);
    setSnackbarSeverity(severity);
    setSnackbarOpen(true);
  }, []);

  // --- API CALL ---
  const fetchBrands = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch(API_BASE_URL);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      setBrands(data);
    } catch (err) {
      setError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th∆∞∆°ng hi·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
      console.error('Fetch brands error:', err);
      showSnackbar(`L·ªói khi t·∫£i th∆∞∆°ng hi·ªáu: ${err instanceof Error ? err.message : String(err)}`, 'error');
    } finally {
      setLoading(false);
    }
  }, [API_BASE_URL, showSnackbar]);

  useEffect(() => {
    fetchBrands();
  }, [fetchBrands]);

  // --- HANDLERS ---
  const handleSnackbarClose = useCallback((_event?: React.SyntheticEvent | Event, reason?: string) => {
    if (reason === 'clickaway') return;
    setSnackbarOpen(false);
  }, []);

  const handleChangePage = useCallback((_event: unknown, newPage: number) => {
    setPage(newPage);
  }, []);

  const handleChangeRowsPerPage = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    setRowsPerPage(parseInt(event.target.value, 10));
    setPage(0);
  }, []);

  const handleRequestSort = useCallback((_event: React.MouseEvent<unknown>, property: HeadCellId) => {
    const isAsc = orderBy === property && order === 'asc';
    setOrder(isAsc ? 'desc' : 'asc');
    setOrderBy(property);
  }, [order, orderBy]);

  const handleSearchChange = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    setSearchTerm(event.target.value);
    setPage(0);
  }, []);

  const handleAddNewBrand = useCallback(() => {
    setEditingBrand(null);
    setModalFormData({ brand_name: '', slug: '', description: '' }); // ‚úÖ TH√äM SLUG V√ÄO KH·ªûI T·∫†O
    setLogoFile(null);
    setLogoPreview('');
    setIsModalOpen(true);
  }, []);

  const handleEdit = useCallback((brand: Brand) => {
    setEditingBrand(brand);
    setModalFormData({ 
      brand_name: brand.brand_name,
      slug: brand.slug, // ‚úÖ LOAD SLUG V√ÄO FORM
      description: brand.description,
    });
    setLogoPreview(brand.logo ? UPLOADS_BASE_URL + brand.logo : '');
    setLogoFile(null);
    setIsModalOpen(true);
  }, [UPLOADS_BASE_URL]);

  const handleDeleteConfirm = useCallback((brandId: number) => {
    setDeletingId(brandId);
    setOpenConfirmDialog(true);
  }, []);

  const handleDelete = useCallback(async () => {
    if (deletingId === null) return;
    try {
      const response = await fetch(`${API_BASE_URL}/${deletingId}`, { // S·ª≠a t·ª´ /delete/:id n·∫øu API ch·ªâ nh·∫≠n /:id
        method: 'DELETE',
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }
      showSnackbar('Th∆∞∆°ng hi·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!', 'success');
      setOpenConfirmDialog(false);
      setDeletingId(null);
      fetchBrands();
    } catch (error) {
      showSnackbar(`L·ªói khi x√≥a th∆∞∆°ng hi·ªáu: ${error instanceof Error ? error.message : String(error)}`, 'error');
    }
  }, [deletingId, fetchBrands, showSnackbar, API_BASE_URL]);

  const handleCloseConfirmDialog = useCallback(() => {
    setOpenConfirmDialog(false);
    setDeletingId(null);
  }, []);

  const handleCloseModal = useCallback(() => {
    setIsModalOpen(false);
    setEditingBrand(null);
    setModalFormData({});
    setLogoFile(null);
    setLogoPreview('');
  }, []);

  const handleModalFormChange = useCallback((e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setModalFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  }, []);

  const handleLogoUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setLogoFile(file);
      setLogoPreview(URL.createObjectURL(file));
    } else {
      setLogoFile(null);
      if (editingBrand && editingBrand.logo) { // Gi·ªØ preview logo c≈© n·∫øu ƒëang s·ª≠a v√† kh√¥ng ch·ªçn file m·ªõi
        setLogoPreview(UPLOADS_BASE_URL + editingBrand.logo);
      } else { // N·∫øu l√† th√™m m·ªõi ho·∫∑c kh√¥ng c√≥ logo c≈©
        setLogoPreview('');
      }
    }
  }, [editingBrand, UPLOADS_BASE_URL]);


  const handleSaveBrand = useCallback(async () => {
    // Validate form data
    if (!modalFormData.brand_name || !modalFormData.slug) { // ‚úÖ Y√™u c·∫ßu slug khi validate
      showSnackbar('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß T√™n Th∆∞∆°ng hi·ªáu v√† Slug.', 'error');
      return;
    }

    try {
      const form = new FormData();
      form.append('brand_name', modalFormData.brand_name || '');
      form.append('slug', modalFormData.slug || ''); // ‚úÖ G·ª¨I SLUG L√äN API
      form.append('description', modalFormData.description || '');
      
      if (logoFile) {
        form.append('logo', logoFile);
      } else if (editingBrand && !logoPreview && editingBrand.logo) {
        // Tr∆∞·ªùng h·ª£p ng∆∞·ªùi d√πng x√≥a logo hi·ªán c√≥ trong preview nh∆∞ng kh√¥ng ch·ªçn logo m·ªõi
        // Backend c·∫ßn x·ª≠ l√Ω vi·ªác gi·ªØ nguy√™n ·∫£nh c≈© n·∫øu tr∆∞·ªùng 'logo' kh√¥ng ƒë∆∞·ª£c g·ª≠i
        // ho·∫∑c g·ª≠i m·ªôt gi√° tr·ªã ƒë·∫∑c bi·ªát ƒë·ªÉ b√°o x√≥a (v√≠ d·ª•: form.append('logo', 'null_to_delete'))
      }

      const method = editingBrand ? 'PUT' : 'POST';
      const url = editingBrand ? `${API_BASE_URL}/${editingBrand.brand_id}` : API_BASE_URL;

      const response = await fetch(url, {
        method,
        body: form,
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }

      showSnackbar(`Th∆∞∆°ng hi·ªáu ƒë√£ ƒë∆∞·ª£c ${editingBrand ? 'c·∫≠p nh·∫≠t' : 'th√™m m·ªõi'} th√†nh c√¥ng!`, 'success');
      handleCloseModal();
      fetchBrands(); // T·∫£i l·∫°i danh s√°ch sau khi l∆∞u
    } catch (error) {
      showSnackbar(`L·ªói khi l∆∞u th∆∞∆°ng hi·ªáu: ${error instanceof Error ? error.message : String(error)}`, 'error');
    }
  }, [editingBrand, modalFormData, logoFile, logoPreview, handleCloseModal, fetchBrands, showSnackbar, API_BASE_URL]);

  // --- MEMOIZED DATA FOR TABLE ---
  const filteredAndSortedBrands = useMemo(() => {
    let currentBrands = brands;

    if (searchTerm) {
      currentBrands = currentBrands.filter((brand) =>
        brand.brand_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        brand.slug.toLowerCase().includes(searchTerm.toLowerCase()) || // ‚úÖ T√åM KI·∫æM THEO SLUG
        brand.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        String(brand.brand_id).includes(searchTerm)
      );
    }
     
    currentBrands = stableSort(currentBrands, getComparator(order, orderBy)); // ‚úÖ S·ª≠a ki·ªÉu truy·ªÅn

    const startIndex = page * rowsPerPage;
    return currentBrands.slice(startIndex, startIndex + rowsPerPage);
  }, [brands, searchTerm, order, orderBy, page, rowsPerPage]);

  const totalFilteredBrands = useMemo(() => {
    let currentBrands = brands;
    if (searchTerm) {
      currentBrands = currentBrands.filter((brand) =>
        brand.brand_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        brand.slug.toLowerCase().includes(searchTerm.toLowerCase()) || // ‚úÖ T√åM KI·∫æM THEO SLUG
        brand.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        String(brand.brand_id).includes(searchTerm)
      );
    }
    return currentBrands.length;
  }, [brands, searchTerm]);

  // --- RENDER ---
  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '80vh' }}>
        <CircularProgress />
        <Typography variant="h6" sx={{ ml: 2 }}>ƒêang t·∫£i d·ªØ li·ªáu th∆∞∆°ng hi·ªáu...</Typography>
      </Box>
    );
  }

  if (error) {
    return (
      <Box 
        sx={{ 
          p: { xs: 2, sm: 3, md: 4 }, 
          backgroundColor: theme.palette.background.default,
          minHeight: '50px', // ƒê·∫∑t minHeight ƒë·ªÉ v√πng l·ªói lu√¥n chi·∫øm kh√¥ng gian
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'center' 
        }}
      >
        <Typography color="error" variant="body1" sx={{ textAlign: 'center' }}>{error}</Typography>
      </Box>
    );
  }

  return (
    <Box sx={{ p: { xs: 2, sm: 3, md: 4 }, backgroundColor: theme.palette.background.default }}>
      <Typography variant="h4" component="h1" gutterBottom sx={{ mb: 4, fontWeight: 'bold', color: theme.palette.primary.dark }}>
        Qu·∫£n L√Ω Th∆∞∆°ng Hi·ªáu
      </Typography>

      <Paper sx={{ p: 3, borderRadius: theme.shape.borderRadius, boxShadow: theme.shadows[3], mb: 3 }}>
        <Box sx={{ display: 'flex', flexDirection: { xs: 'column', sm: 'row' }, justifyContent: 'space-between', alignItems: { xs: 'flex-start', sm: 'center' }, mb: 2, gap: 2 }}>
          <TextField
            label="T√¨m ki·∫øm th∆∞∆°ng hi·ªáu..."
            variant="outlined"
            size="small"
            value={searchTerm}
            onChange={handleSearchChange}
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">
                  <SearchIcon color="action" />
                </InputAdornment>
              ),
            }}
            sx={{ width: { xs: '100%', sm: '300px' } }}
          />
          <Button
            variant="contained"
            color="primary"
            startIcon={<AddIcon />}
            onClick={handleAddNewBrand}
            sx={{ flexShrink: 0 }}
          >
            Th√™m Th∆∞∆°ng hi·ªáu M·ªõi
          </Button>
        </Box>

        <TableContainer>
          <Table aria-label="brand management table">
            <TableHead>
              <TableRow>
                {headCells.map((headCell) => (
                  <TableCell
                    key={headCell.id}
                    align={headCell.numeric ? 'right' : 'left'}
                    sortDirection={orderBy === headCell.id ? order : false}
                    sx={{
                      fontWeight: 'bold',
                      backgroundColor: theme.palette.grey[200],
                      cursor: headCell.disableSorting ? 'default' : 'pointer',
                      // ‚úÖ ƒê·∫∑t chi·ªÅu r·ªông cho c·ªôt M√¥ t·∫£
                      ...(headCell.id === 'description' && { maxWidth: '250px', wordBreak: 'break-word' }), // T·ª± ƒë·ªông xu·ªëng d√≤ng n·∫øu qu√° d√†i
                      // ‚úÖ ƒê·∫∑t chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho c·ªôt H√†nh ƒë·ªông
                      ...(headCell.id === 'actions' && { width: '120px', minWidth: '120px' }), // ƒê√£ th√™m actions v√†o headCells tr∆∞·ªõc ƒë√≥
                    }}
                  >
                    {!headCell.disableSorting ? (
                      <TableSortLabel
                        active={orderBy === headCell.id}
                        direction={orderBy === headCell.id ? order : 'asc'}
                        onClick={(event) => handleRequestSort(event, headCell.id)}
                      >
                        {headCell.label}
                      </TableSortLabel>
                    ) : (
                      headCell.label
                    )}
                  </TableCell>
                ))}
                <TableCell align="right" sx={{ fontWeight: 'bold', backgroundColor: theme.palette.grey[200], width: '120px', minWidth: '120px' }}>H√†nh ƒë·ªông</TableCell> {/* ‚úÖ ƒê·∫∑t width cho header H√†nh ƒë·ªông */}
              </TableRow>
            </TableHead>
            <TableBody>
              {filteredAndSortedBrands.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={headCells.length + 1} align="center" sx={{ py: 3 }}>
                    <Typography variant="subtitle1" color="text.secondary">
                      Kh√¥ng t√¨m th·∫•y th∆∞∆°ng hi·ªáu n√†o.
                    </Typography>
                  </TableCell>
                </TableRow>
              ) : (
                filteredAndSortedBrands.map((brand) => (
                  <TableRow key={brand.brand_id} hover>
                    <TableCell>{brand.brand_id}</TableCell>
                    <TableCell>{brand.brand_name}</TableCell>
                    <TableCell>{brand.slug}</TableCell> 
                       <TableCell>{brand.img}</TableCell> 
                    <TableCell sx={{ maxWidth: '250px', wordBreak: 'break-word' }}>{brand.description}</TableCell> {/* ‚úÖ ƒê·∫∑t maxWidth cho cell m√¥ t·∫£ */}
                    <TableCell align="right" sx={{ width: '120px', minWidth: '120px' }}> {/* ‚úÖ ƒê·∫∑t width cho cell h√†nh ƒë·ªông */}
                      <IconButton
                        aria-label="edit"
                        color="primary"
                        onClick={() => handleEdit(brand)}
                        sx={{ mr: 1 }}
                      >
                        <EditIcon />
                      </IconButton>
                      <IconButton
                        aria-label="delete"
                        color="error"
                        onClick={() => handleDeleteConfirm(brand.brand_id)}
                      >
                        <DeleteIcon />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </TableContainer>

        <TablePagination
          rowsPerPageOptions={[10,20, 50]} 
          component="div"
          count={totalFilteredBrands}
          rowsPerPage={rowsPerPage}
          page={page}
          onPageChange={handleChangePage}
          onRowsPerPageChange={handleChangeRowsPerPage}
          labelRowsPerPage="S·ªë h√†ng m·ªói trang:"
          labelDisplayedRows={({ from, to, count }) =>
            `${from}-${to} tr√™n ${count !== -1 ? count : `h∆°n ${to}`}`
          }
        />
      </Paper>

      {/* Modal Th√™m/Ch·ªânh s·ª≠a Brand */}
      <Dialog open={isModalOpen} onClose={handleCloseModal} fullWidth maxWidth="sm" scroll="paper">
        <DialogTitle>
          {editingBrand ? 'Ch·ªânh s·ª≠a Th∆∞∆°ng hi·ªáu' : 'Th√™m Th∆∞∆°ng hi·ªáu M·ªõi'}
          <IconButton
            aria-label="close"
            onClick={handleCloseModal}
            sx={{
              position: 'absolute',
              right: 8,
              top: 8,
              color: (theme) => theme.palette.grey[500],
            }}
          >
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent dividers>
          <Stack spacing={2} sx={{ mt: 1 }}>
            <TextField
              label="T√™n Th∆∞∆°ng hi·ªáu"
              name="brand_name"
              variant="outlined"
              fullWidth
              value={modalFormData.brand_name || ''}
              onChange={handleModalFormChange}
              required
            />
            <TextField
              label="M√¥ t·∫£"
              name="description"
              variant="outlined"
              fullWidth
              multiline
              rows={3}
              value={modalFormData.description || ''}
              onChange={handleModalFormChange}
            />
            <TextField
              label="Slug"
              name="slug"
              variant="outlined"
              fullWidth
              value={modalFormData.slug || ''}
              onChange={handleModalFormChange}
              required
            />
            <Box>
              <Typography variant="subtitle1" gutterBottom>Logo Th∆∞∆°ng hi·ªáu</Typography>
              <Box sx={{ mt: 1, mb: 2, width: 100, height: 100, border: `1px solid ${theme.palette.divider}`, borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center', overflow: 'hidden' }}>
                {logoPreview ? (
                  <img src={logoPreview} alt="Xem tr∆∞·ªõc Logo" style={{ maxWidth: '100%', maxHeight: '100%', objectFit: 'contain' }} />
                ) : (
                  <Typography variant="caption" color="text.secondary" sx={{ textAlign: 'center' }}>Ch·ªçn logo</Typography>
                )}
              </Box>
              <Button variant="contained" component="label">
                {logoPreview ? 'ƒê·ªïi ·∫£nh' : 'Ch·ªçn ·∫£nh logo'}
                <input hidden accept="image/*" type="file" onChange={handleLogoUpload} />
              </Button>
              {logoPreview && ( 
                 <Button
                    variant="outlined"
                    color="error"
                    onClick={() => { setLogoPreview(''); setLogoFile(null); }}
                    sx={{ ml: 1 }}
                 >
                    X√≥a ·∫£nh
                 </Button>
              )}
            </Box>
          </Stack>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseModal} color="secondary">
            H·ªßy
          </Button>
          <Button
            variant="contained"
            color="primary"
            onClick={handleSaveBrand}
          >
            L∆∞u
          </Button>
        </DialogActions>
      </Dialog>

      {/* Dialog X√°c nh·∫≠n X√≥a */}
      <Dialog
        open={openConfirmDialog}
        onClose={handleCloseConfirmDialog}
        aria-labelledby="alert-dialog-title"
        aria-describedby="alert-dialog-description"
      >
        <DialogTitle id="alert-dialog-title">{"X√°c nh·∫≠n x√≥a th∆∞∆°ng hi·ªáu?"}</DialogTitle>
        <DialogContent>
          <DialogContentText id="alert-dialog-description">
            B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th∆∞∆°ng hi·ªáu n√†y? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.
          </DialogContentText>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseConfirmDialog} color="primary">
            H·ªßy
          </Button>
          <Button onClick={handleDelete} color="error" autoFocus>
            X√≥a
          </Button>
        </DialogActions>
      </Dialog>

      {/* Snackbar th√¥ng b√°o */}
      <Snackbar open={snackbarOpen} autoHideDuration={6000} onClose={handleSnackbarClose}>
        <Alert onClose={handleSnackbarClose} severity={snackbarSeverity} sx={{ width: '100%' }}>
          {snackbarMessage}
        </Alert>
      </Snackbar>
    </Box>
  );
}



















import React, { useEffect, useState, useCallback } from 'react';
import {
  Box, Button, Typography, Table, TableBody, TableCell,
  TableContainer, TableHead, TableRow, Paper, IconButton,
  Dialog, DialogTitle, DialogContent, TextField, DialogActions,
  InputAdornment, MenuItem, Snackbar, Alert, CircularProgress
} from '@mui/material';
import EditIcon from '@mui/icons-material/Edit';
import DeleteIcon from '@mui/icons-material/Delete';
import SearchIcon from '@mui/icons-material/Search';
import axios from 'axios';

interface Product {
  product_id: number;
  name: string;
  description: string;
  price: number;
  quantity: number;
  thumbnail?: string;
  category_id: number;
  brand_id: number;
}

interface Category {
  category_id: number;
  category_name: string;
}

interface Brand {
  brand_id: number;
  brand_name: string;
}

const BASE_URL = 'http://localhost:3000/api';
const UPLOADS_BASE_URL = 'http://localhost:3000/uploads/';

export default function ProductManager() {
  const [products, setProducts] = useState<Product[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [brands, setBrands] = useState<Brand[]>([]);
  const [openDialog, setOpenDialog] = useState(false);
  const [editingProduct, setEditingProduct] = useState<Product | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    name: '', description: '', price: '', quantity: '', thumbnail: null as File | null,
    previewUrl: '', category_id: '', brand_id: ''
  });
  const [alert, setAlert] = useState<{ open: boolean; message: string; severity: 'success' | 'error' | 'info' | 'warning' }>({ open: false, message: '', severity: 'success' });

  // H√†m fetchProducts: T·∫£i s·∫£n ph·∫©m t·ª´ API, c√≥ h·ªó tr·ª£ t√¨m ki·∫øm
 const fetchProducts = useCallback(async (searchQuery: string = '') => {
    setLoading(true);
    setError(null);
    try {
      const url = searchQuery
        ? `${BASE_URL}/products?search=${encodeURIComponent(searchQuery)}`
        : `${BASE_URL}/products`;

      const res = await axios.get(url);

      // ‚úÖ TH√äM 3 D√íNG CODE N√ÄY V√ÄO ƒê√ÇY ‚úÖ
      const rawProducts = res.data; // B∆∞·ªõc 1: L·∫•y d·ªØ li·ªáu s·∫£n ph·∫©m th√¥
      
      // B∆∞·ªõc 2: S·∫Øp x·∫øp l·∫°i danh s√°ch s·∫£n ph·∫©m
      // ƒê·ªÉ s·∫Øp x·∫øp theo ID GI·∫¢M D·∫¶N (v√≠ d·ª•: 16, 15, 14, ...):
      const sortedProducts = [...rawProducts].sort((b, a) => b.product_id - a.product_id);

      // N·∫øu b·∫°n mu·ªën s·∫Øp x·∫øp theo ID TƒÇNG D·∫¶N (v√≠ d·ª•: 12, 13, 14, ...), h√£y d√πng d√≤ng n√†y thay th·∫ø d√≤ng tr√™n:
      // const sortedProducts = [...rawProducts].sort((a, b) => a.product_id - b.product_id);
      
      setProducts(sortedProducts); // B∆∞·ªõc 3: C·∫≠p nh·∫≠t state v·ªõi danh s√°ch ƒë√£ s·∫Øp x·∫øp
      // ===================================================================

    } catch (err) {
      console.error('L·ªói khi l·∫•y s·∫£n ph·∫©m:', err);
      setError('Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.');
      setProducts([]); // X√≥a d·ªØ li·ªáu c≈© n·∫øu c√≥ l·ªói
    } finally {
      setLoading(false);
    }
  }, []); // `fetchProducts` ƒë∆∞·ª£c memoize v√† kh√¥ng c√≥ dependencies thay ƒë·ªïi

  // useEffect ƒë·ªÉ t·∫£i s·∫£n ph·∫©m ban ƒë·∫ßu v√† khi searchTerm thay ƒë·ªïi
  useEffect(() => {
    fetchProducts(searchTerm);
  }, [searchTerm, fetchProducts]); // Dependency array bao g·ªìm searchTerm v√† fetchProducts

  // useEffect ƒë·ªÉ t·∫£i danh m·ª•c v√† th∆∞∆°ng hi·ªáu (ch·ªâ ch·∫°y m·ªôt l·∫ßn khi component mount)
  useEffect(() => {
    const fetchCategoriesAndBrands = async () => {
      try {
        const [categoriesRes, brandsRes] = await Promise.all([
          axios.get(`${BASE_URL}/categories`),
          axios.get(`${BASE_URL}/brands`)
        ]);
        setCategories(categoriesRes.data);
        setBrands(brandsRes.data);
      } catch (err) {
        console.error('L·ªói khi t·∫£i danh m·ª•c ho·∫∑c th∆∞∆°ng hi·ªáu:', err);
        setAlert({ open: true, message: '‚ùå L·ªói khi t·∫£i danh m·ª•c ho·∫∑c th∆∞∆°ng hi·ªáu.', severity: 'error' });
      }
    };
    fetchCategoriesAndBrands();
  }, []);

  // X·ª≠ l√Ω m·ªü form th√™m s·∫£n ph·∫©m
  const handleOpenAdd = () => {
    setEditingProduct(null);
    setFormData({
      name: '', description: '', price: '', quantity: '', thumbnail: null,
      previewUrl: '', category_id: '', brand_id: ''
    });
    setOpenDialog(true);
  };

  // X·ª≠ l√Ω ch·ªânh s·ª≠a s·∫£n ph·∫©m
  const handleEdit = (product: Product) => {
    setEditingProduct(product);
    setFormData({
      name: product.name,
      description: product.description,
      price: product.price.toString(),

      quantity: product.quantity.toString(),
      thumbnail: null,
      previewUrl: product.thumbnail ? `${UPLOADS_BASE_URL}${product.thumbnail}` : '',
      category_id: String(product.category_id),
      brand_id: String(product.brand_id)
    });
    setOpenDialog(true);
  };

  // X·ª≠ l√Ω x√≥a s·∫£n ph·∫©m
  const handleDelete = async (id: number) => {
    if (window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫£n ph·∫©m n√†y?')) {
      try {
        await axios.delete(`${BASE_URL}/products/${id}`);
        setAlert({ open: true, message: 'üóëÔ∏è Xo√° s·∫£n ph·∫©m th√†nh c√¥ng', severity: 'info' });
        fetchProducts(searchTerm); // T·∫£i l·∫°i danh s√°ch sau khi x√≥a, gi·ªØ nguy√™n t·ª´ kh√≥a t√¨m ki·∫øm
      } catch (err) {
        console.error('L·ªói khi x√≥a s·∫£n ph·∫©m:', err);
        setAlert({ open: true, message: '‚ùå L·ªói khi xo√° s·∫£n ph·∫©m', severity: 'error' });
      }
    }
  };

  // ƒê√≥ng dialog
  const handleCloseDialog = () => setOpenDialog(false);

  // X·ª≠ l√Ω thay ƒë·ªïi ·∫£nh
  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null;
    const previewUrl = file ? URL.createObjectURL(file) : '';
    setFormData({ ...formData, thumbnail: file, previewUrl });
  };

  // L∆∞u s·∫£n ph·∫©m (th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t)
  const handleSave = async () => {
    const categoryId = Number(formData.category_id);
    const brandId = Number(formData.brand_id);
    const priceNum = Number(formData.price);
    const quantityNum = Number(formData.quantity);


    if (!formData.name || !formData.description || isNaN(priceNum) || isNaN(quantityNum) || isNaN(categoryId) || isNaN(brandId) || priceNum < 0 || quantityNum < 0) {
      setAlert({ open: true, message: '‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá (gi√°, s·ªë l∆∞·ª£ng ph·∫£i l√† s·ªë kh√¥ng √¢m).', severity: 'warning' });
      return;
    }

    // Ki·ªÉm tra n·∫øu l√† th√™m m·ªõi v√† kh√¥ng c√≥ thumbnail
    if (!editingProduct && !formData.thumbnail) {
      setAlert({ open: true, message: '‚ùå Vui l√≤ng ch·ªçn ·∫£nh s·∫£n ph·∫©m.', severity: 'error' });
      return;
    }

    const data = new FormData();
    data.append('name', formData.name);
    data.append('description', formData.description);
    data.append('price', String(priceNum));
    data.append('quantity', String(quantityNum));
    data.append('category_id', String(categoryId));
    data.append('brand_id', String(brandId));
    if (formData.thumbnail) {
      data.append('thumbnail', formData.thumbnail);
    }
    // Kh√¥ng c·∫ßn g·ª≠i l·∫°i thumbnail c≈© n·∫øu kh√¥ng c√≥ file m·ªõi, backend s·∫Ω gi·ªØ l·∫°i ·∫£nh hi·ªán c√≥

    try {
      if (editingProduct) {
        await axios.put(`${BASE_URL}/products/${editingProduct.product_id}`, data);
        setAlert({ open: true, message: '‚úÖ C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng', severity: 'success' });
      } else {
        await axios.post(`${BASE_URL}/products`, data);
        setAlert({ open: true, message: '‚úÖ Th√™m s·∫£n ph·∫©m th√†nh c√¥ng', severity: 'success' });
      }
      fetchProducts(searchTerm);
      handleCloseDialog();
    } catch (err: any) {
      console.error('Save error:', err.response?.data || err.message);
      setAlert({ open: true, message: `‚ùå L·ªói khi l∆∞u s·∫£n ph·∫©m: ${err.response?.data?.error || err.message}`, severity: 'error' });
    }
  };

  // --- Conditional Rendering for Loading State ---
  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
        <CircularProgress />
        <Typography sx={{ ml: 2 }}>ƒêang t·∫£i s·∫£n ph·∫©m...</Typography>
      </Box>
    );
  }

  // --- Conditional Rendering for Error State ---
  if (error) {
    return (
      <Box sx={{ p: 3, textAlign: 'center' }}>
        <Typography color="error">{error}</Typography>
        <Button variant="contained" onClick={() => fetchProducts(searchTerm)} sx={{ mt: 2 }}>
          Th·ª≠ l·∫°i
        </Button>
      </Box>
    );
  }

  // --- Main Component JSX Return ---
  return (
    <Box sx={{ p: 3 }}>
      {/* Styles should ideally be in a CSS file or using styled components */}
      <style>{`
        .MuiDialogActions-root button {
            width: 120px !important;
            min-width: 120px !important;
        }
        .MuiDialogActions-root {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            justify-content: flex-end !important;
            align-items: center !important;
        }
      `}</style>

      <Typography variant="h5" gutterBottom>Qu·∫£n l√Ω S·∫£n ph·∫©m</Typography>
      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 2, alignItems: 'center' }}>
        <TextField
          placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
          variant="outlined"
          size="small"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === 'Enter') {
              fetchProducts(searchTerm);
            }
          }}
          InputProps={{
            startAdornment: (
              <InputAdornment position="start">
                <SearchIcon />
              </InputAdornment>
            ),
            endAdornment: (
              <InputAdornment position="end">
                <IconButton onClick={() => fetchProducts(searchTerm)}>
                  <SearchIcon />
                </IconButton>
              </InputAdornment>
            ),
          }}
          sx={{ width: '300px' }}
        />
        <Button variant="contained" onClick={handleOpenAdd}>Th√™m s·∫£n ph·∫©m</Button>
      </Box>

      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>ID</TableCell>
              <TableCell>T√™n</TableCell>
              <TableCell>M√¥ t·∫£</TableCell>
              <TableCell>Gi√°</TableCell>
              <TableCell>S·ªë l∆∞·ª£ng</TableCell>
              <TableCell>·∫¢nh</TableCell>
              <TableCell>Danh m·ª•c</TableCell>
              <TableCell>Th∆∞∆°ng hi·ªáu</TableCell>
              <TableCell sx={{ width: '120px', minWidth: '120px' }}>H√†nh ƒë·ªông</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {products.length === 0 && !loading && !error ? (
              <TableRow>
                <TableCell colSpan={9} align="center">
                  Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.
                </TableCell>
              </TableRow>
            ) : (
              products.map((p) => (
                <TableRow key={p.product_id}>
                  <TableCell>{p.product_id}</TableCell>
                  <TableCell>{p.name}</TableCell>
                  <TableCell>{p.description ? p.description.substring(0, 50) + (p.description.length > 50 ? '...' : '') : '‚Äî'}</TableCell>
                  <TableCell>{Number(p.price).toLocaleString('vi-VN')}‚Ç´</TableCell>
                  <TableCell>{p.quantity}</TableCell>
                  <TableCell>
                    <Box
                      sx={{
                        width: 80,
                        height: 80,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        overflow: 'hidden',
                        borderRadius: '8px',
                        border: '1px solid #ddd',
                        backgroundColor: '#f9f9f9',
                      }}
                    >
                      {p.thumbnail ? (
                        <img
                          src={`${UPLOADS_BASE_URL}${p.thumbnail}`}
                          alt={p.name}
                          style={{ maxWidth: '100%', maxHeight: '100%', objectFit: 'contain' }}
                          onError={(e) => {
                            e.currentTarget.src = 'https://via.placeholder.com/80?text=No+Image';
                          }}
                        />
                      ) : (
                        <Typography variant="caption" color="text.secondary">Kh√¥ng c√≥ ·∫£nh</Typography>
                      )}
                    </Box>
                  </TableCell>
                  <TableCell>
                    {categories.find(c => c.category_id === p.category_id)?.category_name || '‚Äî'}
                  </TableCell>
                  <TableCell>{brands.find(b => b.brand_id === p.brand_id)?.brand_name || '‚Äî'}</TableCell>
                  <TableCell align="right" sx={{ width: '120px', minWidth: '120px' }}>
                    <IconButton
                      aria-label="edit"
                      color="primary"
                      onClick={() => handleEdit(p)}
                      sx={{ mr: 1 }}
                    >
                      <EditIcon />
                    </IconButton>
                    <IconButton
                      aria-label="delete"
                      color="error"
                      onClick={() => handleDelete(p.product_id)}
                    >
                      <DeleteIcon />
                    </IconButton>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </TableContainer>

      {/* Dialog form */}
      <Dialog open={openDialog} onClose={handleCloseDialog} fullWidth maxWidth="sm">
        <DialogTitle>{editingProduct ? 'S·ª≠a s·∫£n ph·∫©m' : 'Th√™m s·∫£n ph·∫©m'}</DialogTitle>
        <DialogContent>
          <TextField
            fullWidth label="T√™n" margin="dense"
            value={formData.name}
            onChange={e => setFormData({ ...formData, name: e.target.value })}
          />
          <TextField
            fullWidth label="M√¥ t·∫£" margin="dense" multiline rows={3}
            value={formData.description}
            onChange={e => setFormData({ ...formData, description: e.target.value })}
          />
          <TextField
            fullWidth label="Gi√°" type="number" margin="dense"
            value={formData.price}
            onChange={e => setFormData({ ...formData, price: e.target.value })}
            inputProps={{ min: "0" }}
          />
          <TextField
            fullWidth label="S·ªë l∆∞·ª£ng" type="number" margin="dense"
            value={formData.quantity}
            onChange={e => setFormData({ ...formData, quantity: e.target.value })}
            inputProps={{ min: "0" }}
          />

          <TextField
            select
            fullWidth
            label="Danh m·ª•c"
            margin="dense"
            value={formData.category_id}
            onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}
          >
            {categories.map((c) => (
              <MenuItem key={c.category_id} value={String(c.category_id)}>
                {c.category_name}
              </MenuItem>
            ))}
          </TextField>

          <TextField
            select
            fullWidth
            label="Th∆∞∆°ng hi·ªáu"
            margin="dense"
            value={formData.brand_id}
            onChange={e => setFormData({ ...formData, brand_id: e.target.value })}
          >
            {brands.map(b => (
              <MenuItem key={b.brand_id} value={String(b.brand_id)}>{b.brand_name}</MenuItem>
            ))}
          </TextField>

          <Box sx={{ mt: 2 }} component="label">
            <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>·∫¢nh s·∫£n ph·∫©m</Typography>
            <Box
              sx={{
                width: 100, height: 100, border: '1px dashed #ccc', display: 'flex',
                alignItems: 'center', justifyContent: 'center', position: 'relative',
                overflow: 'hidden', cursor: 'pointer', backgroundColor: '#fafafa'
              }}
            >
              {formData.previewUrl ? (
                <>
                  <img src={formData.previewUrl} alt="preview" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                  <Button
                    size="small" color="error" sx={{
                      position: 'absolute', top: 2, right: 2, fontSize: 10, minWidth: 'unset', px: 1, py: '2px'
                    }}
                    onClick={e => {
                      e.stopPropagation();
                      setFormData({ ...formData, thumbnail: null, previewUrl: '' });
                    }}
                  >X</Button>
                </>
              ) : (
                <Typography variant="caption">Ch·ªçn ·∫£nh</Typography>
              )}
            </Box>
            <input type="file" hidden accept="image/*" onChange={handleImageChange} />
          </Box>
        </DialogContent>
        <DialogActions >
          <Button onClick={handleCloseDialog}>H·ªßy</Button>
          <Button onClick={handleSave} variant="contained">L∆∞u</Button>
        </DialogActions>
      </Dialog>

      <Snackbar open={alert.open} autoHideDuration={3000} onClose={() => setAlert({ ...alert, open: false })}>
        <Alert severity={alert.severity} onClose={() => setAlert({ ...alert, open: false })} sx={{ width: '100%' }}>
          {alert.message}
        </Alert>
      </Snackbar>
    </Box>
  );
}